# iOS 签名原理

![sign](./sign4-768x517.png)

## 非对称加密
简而言之，就是私钥加密的数据必须由对应的公钥解密，公钥加密的数据必须由对应的私钥解密。

## 数字证书
为了理解数字证书，先要理解数字签名。

根据维基百科:
> 数字签名（英语：Digital Signature，又称公钥数字签名）是一种功能类似写在纸上的普通签名、但是使用了公钥加密领域的技术，以用于鉴别数字信息的方法。
> 一套数字签名通常会定义两种互补的运算，一个用于签名，另一个用于验证。

也就是说一段数据被数字签名后，那么就可以确定这段数据由签名方保证，是没有被修改过的。

参考下图：

![digital_sig](./Digital_Signature_diagram_zh-CN.svg)


而数字证书，根据维基百科对[数字证书](https://zh.wikipedia.org/wiki/公開金鑰認證)的定义：
> 简而言之，认证机构用自己的私钥对需要认证的人（或组织机构）的公钥施加数字签名并生成证书，即证书的本质就是对公钥施加数字签名


就是对公钥施加数字签名，保证公钥的身份有效性。

## iOS 签名

这是讨论的是非 AppStore 版本的签名


### ① 本地公私钥
在本地 Mac 上生成的一对公私钥，对应于 keychain 中 “从证书颁发机构请求证书” 操作。

公钥是 CertificateSigningRequest.certSigningRequest 文件，内容如下：

```
-----BEGIN CERTIFICATE REQUEST-----
MIICjTCCAXUCAQAwSDElMCMGCSqGSIb3DQEJARYWemhvdXNvbmcxOTkzQGdtYWls
LmNvbTESMBAGA1UEAwwJU29uZyBaaG91MQswCQYDVQQGEwJDTjCCASIwDQYJKoZI
hvcNAQEBBQADggEPADCCAQoCggEBAL7kJkaTCZI7C28Lnx2F94SeGOdFuzAy8lhb
m2QkYTczn6XlEIUbrPdfpgoCabmzJgnXOY0lvsz+29S/XqXjuSXmYYmyf98Ii3x0
SE53zzsY4pepd5susuldBqABln5DXg+U9t8hU2/ogwZc6E8TqaM23nC/A4l/u+yw
QhWzdTm0Swq54WYb1iiQBqxBztTwPHv3d44LpgP74uJl8q+LnOmRzk0Gw0iG4Gn8
8YJWSkdpyajASeAWgYvoo5ys0f2LKm1yWVwcPi+tiBFwJ3+j/uFl1amnkNKfSt6O
/7P0LlnthwC6O30BWxvk38ppdNsqGzxrnwibIzy884esdP3A6aMCAwEAAaAAMA0G
CSqGSIb3DQEBCwUAA4IBAQB/251k7lGl/Z64FJLRZ0hE2vPLgNvywSWg3u8HpQ8H
QTt/pwMDgJs7EUPhKUztYAQV5JcQkdpx135ENGdYbUhwjZ12oiAW1OcKrysce7SY
dzU3OhhI9UHvHmPn8XUg5zQd7LLDOUargguLrrjEtOqOAo4hZQhzhOkis4Iy77Eb
MxhP2LwVdKtvGJPRRb3wa/jHVK1EE3Izjzvseo19Ihy66Htlt7coI1/dCpUdxu7u
v8T2QQZM0HfNzqMOjbKLyQDvy/UUH0FAb1P9wGzeh+ap8MAd7Uz6W0b8CJLKE44D
9GramK9kZ0BJVXwQh8YUuBap6QZavESIuOR+MH8KFvs+
-----END CERTIFICATE REQUEST-----

```

私钥是保存在 keychian 中  
![mac_private](./mac_private)

## ② Apple 公私钥
私钥在 Apple 后台，公钥在每个 iOS 设备中。

## ③ 对本地公钥签名 
本地公钥被传到 Apple 后台后，会用 Apple 的私钥对本地公钥签名，用来验证本地公钥的合法性。
生成一份证书，里面包含本地公钥和签名。


## ④ 再签名生成 Provisioning Profile
这里有个 Provisioning Profile 的概念，里面会包含第三步的证书，苹果后台申请 AppID，配置好设备 ID 列表和 APP 可使用的权限。
这些组合在一起的数据会用 Apple 的私钥再签名一次。

## ⑤ 签名 App
用本地私钥对 app 签名。然后把 Provisioning Profile 打包到 app 里。

## ⑥ 验证
1. 通过 Apple 的公钥验证 Provisioning Profile 和里面的证书。
2. 通过证书中的公钥（本地公钥）验证 app 的签名
3. 验证设备的 ID 是否在 Provisioning Profile 的 ID 列表中，AppID 是否对应得上，权限开关是否跟 APP 里的 Entitlements 对应等。


